@model Core.Dtos.LoginDto

@{
    ViewData["Title"] = "Giriş Yap";
    Layout = null;
}

<link rel="stylesheet" href="~/css/login.css" />

<div class="login-container">
    <!-- Left Side - Features & Background -->
    <div class="login-left">
        <div class="login-left-content">
            <div class="warehouse-icon">
                <i class="fas fa-warehouse"></i>
            </div>
            <h1>WMS Yönetim Sistemi</h1>
            <p>Depo işlemlerini kolaylaştırın</p>

            <div class="features-grid">
                <div class="feature-card">
                    <i class="fas fa-boxes"></i>
                    <h6>Ürün Yönetimi</h6>
                </div>
                <div class="feature-card">
                    <i class="fas fa-exchange-alt"></i>
                    <h6>Transfer İşlemleri</h6>
                </div>
                <div class="feature-card">
                    <i class="fas fa-chart-bar"></i>
                    <h6>Raporlar</h6>
                </div>
                <div class="feature-card">
                    <i class="fas fa-magnifying-glass"></i>
                    <h6>Stok Sorgulama</h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Side - Login Form -->
    <div class="login-right">
        <div class="login-card">
            <div class="card">
                <div class="card-header">
                    <h4>Giriş Yap</h4>
                </div>
                <div class="card-body">
                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="alert alert-danger alert-custom alert-dismissible fade show" role="alert">
                            @Html.ValidationSummary(false)
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <form id="loginForm" method="post" action="@Url.Action("Login", "Account")">
                        <div class="mb-4">
                            <label for="email" class="form-label">
                                <i class="fas fa-envelope me-2" style="color: #667eea;"></i>Email Adresi
                            </label>
                            <input type="email" class="form-control @(ViewData.ModelState.ContainsKey("Email") && !ViewData.ModelState["Email"].Errors.Any() == false ? "is-invalid" : "")" 
                                   id="email" name="Email" placeholder="Email adresinizi girin" required>
                            @if (ViewData.ModelState.ContainsKey("Email"))
                            {
                                <span class="invalid-feedback">
                                    @Html.ValidationMessage("Email")
                                </span>
                            }
                        </div>

                        <div class="mb-4">
                            <label for="password" class="form-label">
                                <i class="fas fa-lock me-2" style="color: #667eea;"></i>Şifre
                            </label>
                            <input type="password" class="form-control @(ViewData.ModelState.ContainsKey("Password") && !ViewData.ModelState["Password"].Errors.Any() == false ? "is-invalid" : "")" 
                                   id="password" name="Password" placeholder="Şifrenizi girin" required>
                            @if (ViewData.ModelState.ContainsKey("Password"))
                            {
                                <span class="invalid-feedback">
                                    @Html.ValidationMessage("Password")
                                </span>
                            }
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-login text-white">
                                <i class="fas fa-sign-in-alt me-2"></i>Giriş Yap
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Form submit hataları işlemek için
    const loginForm = document.getElementById('loginForm');
    
    // AlertModal'ın başlatılmasını bekle
    function ensureAlertModalInitialized() {
        return new Promise((resolve) => {
            if (typeof AlertModal !== 'undefined' && AlertModal.bootstrapModal) {
                resolve();
            } else {
                // AlertModal başlatılmadıysa, kendi oluştur
                const checkInterval = setInterval(() => {
                    if (typeof AlertModal !== 'undefined' && AlertModal.bootstrapModal) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
                // Maksimum 2 saniye bekle
                setTimeout(() => clearInterval(checkInterval), 2000);
            }
        });
    }
    
    loginForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        try {
            const response = await fetch(this.action, {
                method: 'POST',
                body: new FormData(this)
            });

            // Eğer response başarılı değilse hata oluştur
            if (!response.ok) {
                // JSON hata response varsa işle
                if (response.headers.get('content-type')?.includes('application/json')) {
                    const error = await response.json();
                    await ensureAlertModalInitialized();
                    showErrorModal(error.message || error.error || 'Bir hata oluştu');
                } else {
                    await ensureAlertModalInitialized();
                    showErrorModal('Giriş işlemi başarısız oldu. Lütfen tekrar deneyiniz.');
                }
                return;
            }

            // Başarılı yanıt
            window.location.href = '@Url.Action("Index", "Dashboard")';
        } catch (error) {
            console.error('Login error:', error);
            await ensureAlertModalInitialized();
            showErrorModal('Giriş işlemi sırasında bir hata oluştu: ' + error.message);
        }
    });

    // Modal gösterme fonksiyonu
    function showErrorModal(message) {
        // Eğer AlertModal başlatılmışsa kullan
        if (typeof AlertModal !== 'undefined' && AlertModal.bootstrapModal) {
            AlertModal.error(message);
        } else {
            // Fallback: basit alert
            alert(message);
        }
    }
</script>
